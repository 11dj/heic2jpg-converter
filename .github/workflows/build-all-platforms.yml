name: Build All Platforms

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # Build macOS (Intel + Apple Silicon Universal)
  build-macos:
    runs-on: macos-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        target: aarch64-apple-darwin,x86_64-apple-darwin
        
    - name: Install system dependencies
      run: |
        brew install cmake pkg-config libde265 libheif
        
    - name: Install dependencies
      run: npm install
      
    - name: Build macOS Universal app
      run: npm run tauri build -- --target universal-apple-darwin
      
    - name: Upload macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-build
        path: |
          src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.dmg
          src-tauri/target/universal-apple-darwin/release/bundle/macos/*.app

  # Build Windows
  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        
    - name: Install vcpkg dependencies
      run: |
        vcpkg install libheif:x64-windows-static
        echo "VCPKG_ROOT=$env:VCPKG_INSTALLATION_ROOT" >> $env:GITHUB_ENV
        echo "VCPKGRS_DYNAMIC=1" >> $env:GITHUB_ENV
        
    - name: Install dependencies
      run: npm install
      
    - name: Build Windows app
      run: npm run tauri build
      env:
        PKG_CONFIG_PATH: "${{ env.VCPKG_INSTALLATION_ROOT }}\\installed\\x64-windows-static\\lib\\pkgconfig"
        
    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: |
          src-tauri/target/release/bundle/msi/*.msi
          src-tauri/target/release/bundle/nsis/*.exe

  # Build Linux
  build-linux:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf
        sudo apt-get install -y cmake libde265-dev libheif-dev
        
    - name: Install Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        
    - name: Install dependencies
      run: npm install
      
    - name: Build Linux app
      run: npm run tauri build
      
    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-build
        path: |
          src-tauri/target/release/bundle/deb/*.deb
          src-tauri/target/release/bundle/appimage/*.AppImage

  # Collect all builds and commit to builds folder
  collect-and-commit:
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: Display structure
      run: ls -R artifacts
      
    - name: Prepare builds folder
      run: |
        mkdir -p builds
        rm -rf builds/*
        
        # macOS
        mkdir -p builds/macos
        cp artifacts/macos-build/**/*.dmg builds/macos/ 2>/dev/null || true
        
        # Windows
        mkdir -p builds/windows
        cp artifacts/windows-build/**/*.msi builds/windows/ 2>/dev/null || true
        cp artifacts/windows-build/**/*.exe builds/windows/ 2>/dev/null || true
        
        # Linux
        mkdir -p builds/linux
        cp artifacts/linux-build/**/*.deb builds/linux/ 2>/dev/null || true
        cp artifacts/linux-build/**/*.AppImage builds/linux/ 2>/dev/null || true
        
        # Create README in builds folder
        cat > builds/README.md << 'EOF'
        # HEIC2JPG Converter Builds
        
        ## Latest Release Builds
        
        | Platform | File | Description |
        |----------|------|-------------|
        | macOS | `*.dmg` | macOS Disk Image (Universal - Intel & Apple Silicon) |
        | Windows | `*.msi` | Windows Installer |
        | Windows | `*-setup.exe` | NSIS Installer |
        | Linux | `*.deb` | Debian Package |
        | Linux | `*.AppImage` | Portable AppImage |
        
        ## Version
        - Version: 1.0.0
        - Author: 11dj (https://github.com/11dj)
        - License: MIT
        
        ## Features
        - ✅ Drag & Drop support
        - ✅ HEIC to JPEG conversion (all platforms)
        - ✅ Quality adjustment (1-100%)
        - ✅ Size estimation
        - ✅ Batch conversion
        - ✅ ZIP export
        
        ## Installation
        
        ### macOS
        1. Download `.dmg` file
        2. Open and drag to Applications
        3. Right-click app → Open (to bypass Gatekeeper)
        
        ### Windows
        1. Download `.msi` or `.exe` file
        2. Run installer
        3. The app includes all necessary HEIC codecs
        
        ### Linux
        ```bash
        # Debian/Ubuntu
        sudo dpkg -i *.deb
        
        # Or use AppImage
        chmod +x *.AppImage
        ./HEIC2JPG*.AppImage
        ```
        
        ## Build Date
        These builds were automatically generated by GitHub Actions.
        EOF
        
    - name: Commit builds to repository
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        # Add all builds
        git add builds/
        
        # Check if there are changes
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Update builds - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
          echo "Builds committed successfully!"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Create Release (only on tags)
  create-release:
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/macos-build/**/*
          artifacts/windows-build/**/*
          artifacts/linux-build/**/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
